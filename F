WITH base_rows AS (
    -- 1. Take the date (day only) and message text
    SELECT
        TRUNC(TO_DATE(t.T_FILTERED, 'YYYY/MM/DD HH24:MI:SS')) AS msg_date,
        t.T_MESSAGE
    FROM SANCTIONS_OWNER.FOFA_HIST_MESSAGE t
    WHERE TRUNC(TO_DATE(t.T_FILTERED, 'YYYY/MM/DD HH24:MI:SS'))
          BETWEEN DATE '2024-08-20' AND DATE '2024-08-31'  -- <-- adjust window
),
extracted AS (
    -- 2. Split each message into one row per [ ... ] token
    SELECT
        b.msg_date,
        REGEXP_SUBSTR(
            CAST(b.T_MESSAGE AS VARCHAR2(4000)),
            '\[([^\]]*?)\]',      -- capture inside the brackets
            1,
            n.lvl,
            NULL,
            1
        ) AS raw_token
    FROM base_rows b
    CROSS APPLY (
        SELECT LEVEL AS lvl
        FROM dual
        CONNECT BY LEVEL <= REGEXP_COUNT(
            CAST(b.T_MESSAGE AS VARCHAR2(4000)),
            '\[[^\]]*?\]'         -- same pattern but no capture
        )
    ) n
),
cleaned AS (
    -- 3. Normalize token text and drop tokens ending in X
    SELECT
        msg_date,
        UPPER(RTRIM(raw_token)) AS keyword
    FROM extracted
    WHERE raw_token IS NOT NULL
      AND NOT REGEXP_LIKE(RTRIM(raw_token), 'X$')  -- filter out tokens ending with X
),
dedup AS (
    -- 4. Unique (date, keyword) pairs per day
    SELECT DISTINCT
        msg_date,
        keyword
    FROM cleaned
),
first_seen AS (
    -- 5. First day each keyword ever appeared
    SELECT
        keyword,
        MIN(msg_date) AS first_date
    FROM dedup
    GROUP BY keyword
),
final_per_day AS (
    -- 6. Keep only keywords whose FIRST-EVER appearance
    --    is still inside our reporting window
    SELECT
        first_date AS msg_date,
        keyword
    FROM first_seen
    WHERE first_date BETWEEN DATE '2024-08-20' AND DATE '2024-08-31'  -- same window as base_rows
)
-- 7. Present “new tokens per day”
SELECT
    msg_date,
    LISTAGG(keyword, ', ')
        WITHIN GROUP (ORDER BY keyword) AS new_keywords_that_day
FROM final_per_day
GROUP BY msg_date
ORDER BY msg_date;








SELECT
    TRUNC(TO_DATE(t.T_FILTERED, 'YYYY/MM/DD HH24:MI:SS')) AS msg_date,
    REGEXP_SUBSTR(
        CAST(t.T_MESSAGE AS VARCHAR2(4000)),
        '\[([^\]]*?)\]',        -- find [ ... ], capture inside
        1,
        n.lvl,
        NULL,
        1                       -- return capture group 1 = inside text
    ) AS raw_token
FROM SANCTIONS_OWNER.FOFA_HIST_MESSAGE t
CROSS APPLY (
    SELECT LEVEL AS lvl
    FROM dual
    CONNECT BY LEVEL <= REGEXP_COUNT(
        CAST(t.T_MESSAGE AS VARCHAR2(4000)),
        '\[[^\]]*?\]'           -- same shape, no capture group
    )
) n
WHERE TRUNC(TO_DATE(t.T_FILTERED, 'YYYY/MM/DD HH24:MI:SS'))
      BETWEEN DATE '2024-08-24' AND DATE '2024-08-24';




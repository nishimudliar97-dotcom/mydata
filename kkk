# pip install pandas openpyxl
import re
from pathlib import Path
import pandas as pd

# ======= CONFIG =======
FOLDER = r"D:\path\to\your\excel\folder"   # <-- set this
OUTPUT = Path(FOLDER) / "keyword_first_occurrence.xlsx"
# ======================

# exact capture of text between a single pair of square brackets
BRACKET_RE = re.compile(r"\[([^\[\]]+)\]")

records = []

# gather Excel files
excel_paths = [p for ext in ("*.xlsx", "*.xlsm", "*.xls") for p in Path(FOLDER).rglob(ext)]
if not excel_paths:
    raise SystemExit(f"No Excel files found under: {FOLDER}")

for path in sorted(excel_paths):
    try:
        df = pd.read_excel(path, dtype=str)
    except Exception as e:
        print(f"Skipping {path.name}: {e}")
        continue

    # find columns (case-insensitive) â€“ we won't touch the bracket contents
    cols_lower = {c.lower(): c for c in df.columns}
    date_col = (
        cols_lower.get("messagedate") or cols_lower.get("msg_date")
        or cols_lower.get("message_date") or cols_lower.get("msgdate")
        or cols_lower.get("date")
    )
    msg_col = (
        cols_lower.get("t__message") or cols_lower.get("t_message")
        or cols_lower.get("message") or cols_lower.get("tmsg") or cols_lower.get("msg")
    )
    if not date_col or not msg_col:
        print(f"Skipping {path.name}: couldn't find MessageDate and/or T__Message.")
        continue

    dates = pd.to_datetime(df[date_col], errors="coerce")

    for dt, msg in zip(dates, df[msg_col].astype(str, copy=False)):
        if pd.isna(dt) or msg == "nan":
            continue
        for token in BRACKET_RE.findall(msg):
            # keep token EXACTLY as in the brackets (no trimming/case changes)
            records.append({"Keyword": token, "FirstOccurrence": dt})

if not records:
    print("No bracketed keywords were found.")
else:
    hits = pd.DataFrame(records)
    hits.sort_values(["Keyword", "FirstOccurrence"], inplace=True)
    firsts = hits.drop_duplicates("Keyword", keep="first")
    firsts.to_excel(OUTPUT, index=False)
    print(f"Saved {len(firsts)} rows to: {OUTPUT}")

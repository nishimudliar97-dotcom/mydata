import os, re
from pathlib import Path
import pandas as pd

# ====== SETTINGS ======
FOLDER   = r"C:\Users\...\Downloads\A"          # input folder
KEYWORD  = "CDTBRL03"
OUTFILE  = r"C:\Users\...\Downloads\A\hits.xlsx"
WHOLE_WORD = False
CASE_INSENSITIVE = True
CONTEXT_CHARS = 20
CONTEXT_COL   = f"context_{CONTEXT_CHARS}"      # <-- single source of truth
# ======================

boundary = r"\b" if WHOLE_WORD else ""
flags = re.IGNORECASE if CASE_INSENSITIVE else 0
PATTERN = re.compile(boundary + re.escape(KEYWORD) + boundary, flags)

DATE_CANDIDATES = {"msg_date", "message_date", "date", "msgdate"}
MSG_CANDIDATES  = {"t__message", "t_message", "message", "t__msg", "t msg", "t-message"}

def _select_usecols(col_name: str) -> bool:
    c = (col_name or "").strip().lower()
    return c in DATE_CANDIDATES or c in MSG_CANDIDATES

def _normalize_columns(df: pd.DataFrame) -> pd.DataFrame:
    lower = {c: c.strip().lower() for c in df.columns}
    inv = {v: k for k, v in lower.items()}
    date_col = next((inv[c] for c in DATE_CANDIDATES if c in inv), None)
    msg_col  = next((inv[c] for c in MSG_CANDIDATES  if c in inv), None)
    if date_col is None or msg_col is None:
        raise ValueError(f"Could not find required columns in: {list(df.columns)}")
    return df[[date_col, msg_col]].rename(columns={date_col:"MSG_DATE", msg_col:"T__MESSAGE"})

def _first_context(text: str) -> str:
    if not isinstance(text, str):
        text = "" if pd.isna(text) else str(text)
    m = PATTERN.search(text)
    if not m:
        return ""
    start = max(0, m.start() - CONTEXT_CHARS)
    end   = min(len(text), m.end() + CONTEXT_CHARS)
    return text[start:end]

def process_file(path: Path) -> pd.DataFrame:
    try:
        engine = "pyxlsb" if path.suffix.lower() == ".xlsb" else None
        df = pd.read_excel(path, engine=engine, usecols=_select_usecols, dtype=str)
        df = _normalize_columns(df)
        hits = df["T__MESSAGE"].fillna("").str.contains(PATTERN, regex=True)
        if not hits.any():
            return pd.DataFrame(columns=["MSG_DATE","T__MESSAGE","keyword",CONTEXT_COL,"source_file"])
        sub = df.loc[hits].copy()
        sub["keyword"] = KEYWORD
        sub[CONTEXT_COL] = sub["T__MESSAGE"].map(_first_context)
        sub["source_file"] = path.name
        return sub[["MSG_DATE","T__MESSAGE","keyword",CONTEXT_COL,"source_file"]]
    except Exception as e:
        print(f"[WARN] Skipped {path.name}: {e}")
        return pd.DataFrame(columns=["MSG_DATE","T__MESSAGE","keyword",CONTEXT_COL,"source_file"])

def main():
    folder = Path(FOLDER)
    files = sorted(p for p in folder.glob("*.xls*") if p.is_file())
    # Don’t read the output file if it’s in the same folder
    outpath = Path(OUTFILE).resolve()
    files = [p for p in files if p.resolve() != outpath]

    parts = [process_file(p) for p in files]
    result = pd.concat(parts, ignore_index=True) if parts else pd.DataFrame(columns=["MSG_DATE","T__MESSAGE","keyword",CONTEXT_COL,"source_file"])
    result.to_excel(OUTFILE, index=False)
    print(f"Done. Files scanned: {len(files)} | Matches: {len(result)}")
    print(f"Output -> {OUTFILE}")

if __name__ == "__main__":
    main()
